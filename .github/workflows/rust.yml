name: Rust

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  PROJECT_DIR: acme-dns-client

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    defaults:
      run:
        shell: bash
        working-directory: ${{ env.PROJECT_DIR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update Rust stable
        run: rustup toolchain install stable --profile minimal

      # Preprocess Cargo.lock to ignore this package's version for cache hashing
      - name: Prepare Cargo.lock for caching (ignore package version)
        run: |
          PROJECT_NAME="$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].name')"
          awk -v pkg="$PROJECT_NAME" '
            /^\[\[package\]\]/{p=0}
            $0 ~ "^name = \"" pkg "\"$"{p=1}
            p && /^version = /{next}
            {print}
          ' Cargo.lock > Cargo.lock.no-version

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles(format('{0}/Cargo.lock.no-version', env.PROJECT_DIR)) }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Restore third-party dependencies cache
        uses: actions/cache@v4
        with:
          path: ${{ env.PROJECT_DIR }}/target
          key: ${{ runner.os }}-cargo-deps-${{ hashFiles(format('{0}/Cargo.lock.no-version', env.PROJECT_DIR)) }}
          restore-keys: |
            ${{ runner.os }}-cargo-deps-

      - name: Install cargo-binstall
        run: |
          curl -L --proto '=https' --tlsv1.2 -sSf \
            https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash

      - name: Install Just
        run: cargo binstall --no-confirm just

      - name: Install other dependencies listed in Justfile (bin-deps)
        run: just bin-deps

      - name: Run coverage report
        run: just test-coverage --release && ls -lha ./target/llvm-cov/html

      - name: Extract project information
        id: project_info
        run: |
          project_name="$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].name')"
          echo "PROJECT_NAME=$project_name" >> "$GITHUB_ENV"

          branch_name="${GITHUB_HEAD_REF:-${GITHUB_REF##*/}}"
          echo "BRANCH_NAME=$branch_name" >> "$GITHUB_ENV"

          commit_sha="$GITHUB_SHA"
          commit_url="https://github.com/${{ github.repository }}/commit/${commit_sha}"
          echo "COMMIT_SHA=$commit_sha" >> "$GITHUB_ENV"
          echo "COMMIT_URL=$commit_url" >> "$GITHUB_ENV"

      - name: Inject meta information into index.html
        run: |
          sed -i "/<\/body>/i <div style=\"position:fixed;bottom:10px;left:10px;font-size:12px;color:#666\">Project: ${PROJECT_NAME} | Branch: ${BRANCH_NAME} | <a href=\"${COMMIT_URL}\">Commit: ${COMMIT_SHA}</a></div>" \
            ./target/llvm-cov/html/index.html

      - name: Stage Pages content
        run: |
          rm -rf pages-root
          mkdir -p "pages-root/coverage/${BRANCH_NAME}"
          cp -a target/llvm-cov/html/. "pages-root/coverage/${BRANCH_NAME}/"

      - name: Upload coverage site artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.PROJECT_DIR }}/pages-root

      - name: Remove project-specific artifacts
        run: |
          PROJECT_NAME="$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].name')"
          # remove any files/dirs in target whose name contains the project name
          find target -name "*${PROJECT_NAME}*" -exec rm -rf {} +

  deploy-coverage:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    permissions:
      pages: write
      id-token: write
      contents: read

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
